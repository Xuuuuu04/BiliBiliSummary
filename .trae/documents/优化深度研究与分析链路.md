## 目标
- 提升深度研究链路的稳定性（避免隐藏运行时错误、降低 429/超时失败率）
- 降低成本与时延（减少重复拉取/重复推理、控制上下文膨胀）
- 降低维护成本（消除 Agent 层与 Tool 层的重复实现、统一工具 schema 与执行入口）

## 现状与关键问题
- 工具路径存在确定性运行错误：`AnalyzeVideoTool` 引用不存在的 `get_video_analyzer_for_agent_prompt`（见 [analyze_video.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/toolkit/tools/analyze_video.py#L125-L139) 与 [prompts.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/prompts.py)）。
- `analyze_video` 逻辑在 Agent 内与 Tool 内重复实现，能力不一致（取帧/并发/提示词/输出风格不同），导致行为漂移与难以优化。
- Agent 自己硬编码 tools schema 与执行分支（`_get_tools_definition`、`_execute_tool`），ToolRegistry 的统一能力被绕开。
- 出站请求缺少统一的超时分层、重试退避、429/5xx 处理与全局并发阈值。
- 缓存缺失 + messages 不裁剪，轮次增长后 token 成本与失败率上升。

## 改动方案（按优先级）
1) 修复工具版 `analyze_video` 的缺失 prompt 引用
- 方案 A（推荐）：直接改用现有 `get_video_analysis_prompt`，并与 Agent 分支保持同口径。
- 方案 B：补齐 `get_video_analyzer_for_agent_prompt` 并明确其用途（仅 Agent/仅 Tool）。
- 影响文件：
  - [toolkit/tools/analyze_video.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/toolkit/tools/analyze_video.py)
  - [prompts.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/prompts.py)

2) 统一 `analyze_video` 的权威实现（消除双实现）
- 将“拉取视频信息/字幕/弹幕/评论/帧 + 多模态分析 + 流式进度”沉到 `AnalyzeVideoTool.execute_stream`。
- Agent 不再内联分析逻辑，仅负责：
  - 批量 tool_calls 的并发调度（用 `asyncio` + semaphore 控制并发）
  - 将每个视频的工具输出以 `tool` message 形式回填给模型
- 影响文件：
  - [deep_research_agent.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/agents/deep_research_agent.py)
  - [toolkit/tools/analyze_video.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/toolkit/tools/analyze_video.py)

3) 统一工具 schema 与执行入口到 ToolRegistry
- `tools` 参数改为从 ToolRegistry 聚合生成（替代 `_get_tools_definition`），避免 schema 与实现漂移。
- `_execute_tool` 收敛为统一入口（例如 `ToolRegistry.execute_stream/execute`），Agent 侧只保留调度策略。
- 影响文件：
  - [deep_research_agent.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/agents/deep_research_agent.py)
  - [tool_registry.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/toolkit/tool_registry.py)

4) 加“出站可靠性层”：超时、重试退避、429 处理、全局并发控制
- 新增统一包装：
  - OpenAI：针对 429/5xx/连接超时做指数退避 + 抖动，限制最大重试次数。
  - Exa：将同步请求改为可控超时分层并引入重试策略。
  - B站：对高成本接口（帧提取/评论翻页）加单独的并发阈值。
- 引入分层 semaphore（建议默认：OpenAI=2、B站=4、Exa=1、帧提取=1）。
- 影响文件：
  - [ai_helpers.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/ai_helpers.py)
  - [deep_research_agent.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/agents/deep_research_agent.py)
  - 以及相关工具实现文件（如 web_search/analyze_video）。

5) 加缓存与消息治理（控成本、控时延、控上下文膨胀）
- 进程内 TTL cache：
  - Exa：`query+params -> results`
  - B站：`bvid -> info/subtitles/danmaku/comments/frames`
- messages 裁剪/摘要：
  - 每 N 轮把工具长输出压缩为结构化摘要（含来源引用），替换原始大段文本。
- 影响文件：
  - [deep_research_agent.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/agents/deep_research_agent.py)
  - [ai_helpers.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/ai_helpers.py)

6) Prompt 风格配置化（研究默认“专业”）
- 将 “多用 Emoji” 等风格约束变成可选项；深度研究走专业风格。
- 影响文件：
  - [prompts.py](file:///Users/xushaoyang/Desktop/Bilibili_Analysis_Helper/src/backend/services/ai/prompts.py)
  - 可能需要在配置层透传（如 `Config`）。

## 验证方式
- 新增/完善后端测试或最小可运行用例，覆盖：
  - 直接调用工具版 `AnalyzeVideoTool.execute_stream` 不再报错（缺失 prompt 修复验证）
  - 深度研究触发批量 `analyze_video` 时，能够并发执行且不会因 thread/async 混用卡死
  - 429/超时场景下能够退避重试并最终给出可理解错误
  - 同一 bvid/query 的重复调用命中缓存（验证缓存生效）
- 本地跑一次“深度研究”端到端流程，确保报告仍能生成并落盘。

## 交付物
- 代码层面：消除双实现、统一工具入口、修复工具炸点、加入并发/重试/缓存/摘要治理。
- 行为层面：稳定性提升（更少 429/超时）、成本下降（更少重复 token 与重复数据拉取）、输出一致性提高。

如果你确认该计划，我将按上述顺序开始落地实现，并在每个阶段完成后做对应验证。