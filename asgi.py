"""
================================================================================
ASGI 应用入口 (asgi.py)
================================================================================

【架构位置】
这是整个应用的入口点，位于项目根目录。
ASGI 服务器（如 Uvicorn）通过加载此文件来启动应用。

【设计模式】
- 应用入口模式：作为 WSGI/ASGI 服务器的标准入口
- 初始化顺序模式：确保日志系统最先启动

【主要功能】
1. 初始化日志系统
2. 创建 FastAPI 应用实例
3. 暴露 app 对象供 ASGI 服务器使用

【启动方式】
# 开发环境
uvicorn asgi:app --host 0.0.0.0 --port 5001 --reload

# 生产环境
uvicorn asgi:app --host 0.0.0.0 --port 5001 --workers 4

【执行流程】
1. 导入必要的模块
2. 调用 setup_logging() 初始化日志系统
3. 调用 create_app() 创建 FastAPI 应用
4. ASGI 服务器加载 app 对象并开始监听请求

【注意事项】
- 日志必须在其他模块之前初始化
- app 对象必须全局可访问
- 不要在此处执行耗时的初始化操作

================================================================================
"""

import logging

# 导入应用工厂函数
from src.backend.http.app import create_app

# 导入日志设置函数
from src.backend.utils.logger import setup_logging

# ========================================================================
# 第一步：初始化日志系统
# ========================================================================
# 日志系统必须在所有其他操作之前初始化，这样其他模块的日志才能正确输出
#
# 参数说明：
# - level: 全局日志级别，设置为 INFO 表示只输出 INFO 及以上级别的日志
# - console_level: 控制台日志级别，设置为 INFO 表示控制台输出 INFO 及以上
# - log_to_file: 是否输出到文件，True 表示日志会同时输出到文件和控制台
#
# 日志文件位置：logs/app_YYYYMMDD.log（每天一个文件）
setup_logging(level=logging.INFO, console_level=logging.INFO, log_to_file=True)

# ========================================================================
# 第二步：创建 FastAPI 应用
# ========================================================================
# 使用应用工厂模式创建应用实例
# 这样做的好处：
# 1. 可以延迟初始化，避免循环导入
# 2. 可以创建多个应用实例（测试场景）
# 3. 可以根据不同配置创建不同应用
#
# create_app() 会完成以下工作：
# 1. 创建 FastAPI 实例
# 2. 注册全局异常处理器
# 3. 添加 CORS 中间件
# 4. 注册所有 API 路由
# 5. 挂载静态文件服务
app = create_app()

# ========================================================================
# 应用启动完成
# ========================================================================
# 此时 app 对象已经完全初始化，可以被 ASGI 服务器使用
#
# 当运行 uvicorn asgi:app 时：
# 1. Uvicorn 会导入这个文件
# 2. 执行初始化代码（设置日志、创建应用）
# 3. 获取 app 对象
# 4. 启动 ASGI 服务器，开始监听请求
# 5. 收到请求后，通过 app 对象的路由系统分发到对应的处理函数
