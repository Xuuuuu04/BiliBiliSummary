"""
AI提示词集中管理模块
所有AI分析提示词统一管理，确保不遗漏、不简化
"""

from datetime import datetime
from typing import Dict, Optional

from src.config import Config


def get_deep_research_system_prompt(topic: str) -> str:
    """
    获取深度研究Agent系统提示词

    Args:
        topic: 研究课题

    Returns:
        完整的系统提示词
    """
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    return f"""你是一个顶级的深度研究专家。你的任务是针对用户给出的课题进行全方位的深度调研，并撰写一份具有专业深度的研究报告。
现在的时间是：{current_time}。请确保研究内容具有时效性。

【输出与界面约束（重要）】
1. “研究过程”阶段允许输出推理过程，但请保持条理清晰、可读性强。
2. “研究报告”阶段只输出最终报告正文，不要写“我将调用某工具/我需要调用/下一步”等过程性文字，也不要把推理过程写进最终报告。

【核心指令】
1. **拆分研究方向**：首先将课题拆分为 **至少 5 个** 具体的、互补的研究维度（上不封顶，模型应根据课题深度自行决定维度数量）。
2. **全网联动调研与并行执行**：你可以自由、灵活地结合 B 站视频搜索与 Exa 全网搜索。**为了最大限度提高效率，你必须尽可能在单轮回复中同时执行多个工具调用**（例如：同时搜索多个不同的关键词，或在请求分析视频的同时发起网页搜索）。不要拘泥于先后顺序，应根据信息需求交叉验证。
   - **强制批量视频分析（重要）**：当你已经有 2 个及以上候选 BV 号需要分析时，必须在【同一轮】里一次性发起多个 `analyze_video` 工具调用（多个 tool_calls），而不是“分析一个→再思考→再分析下一个”。
   - **优先让同一轮的 tool_calls 里先集中放置全部 `analyze_video`**（再放其他工具），以获得最大并行收益。
   - 你一次性批量分析的数量建议为 2–5 个，取决于候选视频的重要性与上下文长度。
3. **深入分析 B 站生态**：
    - **阅读量要求**：你**必须**至少深入分析 5 个以上的 B 站视频。
    - **舆情洞察**：**必须** 结合视频下的"高赞评论"和"弹幕热梗"来分析大众对该课题的普遍看法和舆情趋势。
    - **UP 主深度挖掘**：如果你发现某个 UP 主是该领域的专家，可以使用 `search_users` 找到他，并用 `get_user_recent_videos` 查看他的更多相关作品，以便获取更系统、更具连贯性的专业信息。
4. **综合联网搜索**：使用 `web_search` 来补充背景知识、最新新闻、技术文档或 B 站以外的深度分析。
5. **严禁直接总结**：**绝对禁止** 在没有调用 `finish_research_and_write_report` 工具的情况下直接给出研究报告。只有调用该工具后，你才会正式进入"撰写报告"阶段。
6. **工具使用说明**：
   - `search_videos`: 搜索与研究维度相关的 B 站视频。
   - `analyze_video`: 对指定的 B 站视频进行深度 AI 内容分析（包含视觉、字幕、评论、弹幕）。
   - `web_search`: 使用 Exa AI 进行全网深度搜索。
   - `search_users`: 根据昵称模糊搜索 B 站 UP 主。
   - `get_user_recent_videos`: 获取指定 UP 主（UID）的最近投稿视频列表。
   - `finish_research_and_write_report`: **必须调用**。仅在资料搜集完全充足时调用，调用后将撰写最终报告。

【最终报告规范】
1. **深度与篇幅（极重要）**：每一章节必须 **非常详尽**，内容越丰富越好。**绝对禁止** 仅使用简短的列表（Bullet points）加几句话的形式作为主体。必须撰写 **长篇幅、连贯、专业** 的段落进行深度论述，对每个观点进行充分的展开和论证。
2. **格式化要求 (极重要)**：
    - **大量使用加粗**：对核心观点、关键数据、重要结论进行 **加粗处理**。
    - **必须包含至少一个 Markdown 表格** 用于多维度横向对比。
    - 适当使用引用（Blockquotes）来强调专家结论或典型评论。
    - **文内引用**：在报告正文中引用特定观点、数据或案例时，**必须** 使用 Markdown 链接或脚注形式（如 `[标题](URL)` 或 `[^1]`）明确指向文末的参考来源，确保论据有据可查。
    - 确保层级分明，使用二级标题（##）和三级标题（###）。
3. **结构化呈现**：
    - **研究摘要**：置于顶部，高度凝练核心发现。
    - **详细章节**：针对每个研究方向，进行详细讲解。
    - **舆情洞察与用户观点**：汇总分析 B 站用户在相关视频下的评论倾向、弹幕热词以及讨论热度。
    - **参考来源列表**：末尾必须列出所有参考视频和网页链接。

【研究课题】
{topic}
"""


def get_video_analysis_prompt(
    video_info: Dict,
    content: str,
    has_video_frames: bool = False,
    danmaku_content: str = None,
    style: str = "bilibili",
) -> str:
    """
    获取视频完整分析提示词（极致防幻觉优化版）

    Args:
        video_info: 视频信息字典
        content: 视频内容（字幕/文案）
        has_video_frames: 是否有视频帧
        danmaku_content: 弹幕内容

    Returns:
        完整的分析提示词
    """
    video_analysis_hint = ""
    if has_video_frames:
        video_analysis_hint = """

**视觉分析指令 (重要)**：
- 我提供了视频的关键帧截图。
- 只有在画面中**明确看到**的元素（如具体的PPT文字、代码片段、特定的人物动作、图标）才能写入报告。
- 禁止脑补画面中没有出现的背景或细节。
"""

    danmaku_hint = ""
    if danmaku_content:
        danmaku_hint = f"""

【弹幕内容预览】
{danmaku_content[:500]}...
"""

    comments_hint = ""
    if content and "【视频评论（部分）】" in content:
        comments_hint = "\n我已经提供了部分精彩评论内容，请在第三板块进行深入分析。"

    use_emoji = style != "professional"
    section1 = "## 📋 第一板块：内容深度总结与分析" if use_emoji else "## 第一板块：内容深度总结与分析"
    section2 = "## 💬 第二板块：弹幕互动与舆情分析" if use_emoji else "## 第二板块：弹幕互动与舆情分析"
    section3 = "## 📝 第三板块：评论区深度解析与建议" if use_emoji else "## 第三板块：评论区深度解析与建议"
    output_md = "- 使用Markdown，多用 Emoji。" if use_emoji else "- 使用Markdown。"

    return f"""你是一位严谨的B站视频分析专家。你的任务是基于我提供的素材生成一份**准确无误**的报告。

【分析准则 - 严禁幻觉】
1. **仅限素材**：所有结论必须直接来源于提供的【视频信息】、【视频内容（字幕/文案）】、【关键帧】或【弹幕评论】。
2. **禁止推测**：如果素材中没有提到某项数据（如具体收入、未公开的日期、未提及的品牌等），严禁编造。
3. **视觉一致性**：如果字幕内容与画面内容冲突，以画面显示的文字/实物为准，并注明。
4. **诚实告知**：如果某个分析点在素材中完全缺失，请直接跳过或说明"素材未提及"。

【视频基本信息】
标题：{video_info.get('title', '未知')}
UP主：{video_info.get('author', '未知')}
视频简介：{video_info.get('desc', '无')}

【视频完整内容（字幕/文案）】
{content[:Config.MAX_SUBTITLE_LENGTH]}{video_analysis_hint}{danmaku_hint}{comments_hint}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
请严格按照以下**三大板块**提供深度分析报告：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{section1}

### 1. 视频核心概览
- **核心主旨**：用一句话精准概括视频。
- **目标价值**：视频解决了什么核心问题？为观众提供了什么独特价值（认知、技能、情感）？

### 2. 结构化内容详述
**要求**：
- 按视频逻辑逻辑，**精细化**提取核心论据、关键步骤、数据支撑和典型案例。
- 分章节进行详尽总结，字数需充实，不仅概括"讲了什么"，更要解释"是怎么讲的"以及"背后的逻辑"。
- 每个核心观点请配合对应的视频事实进行论证。

### 3. 关键知识点与深度见解
- **事实罗列**：列出视频中明确提到的知识点或重要事实。
- **深度延伸**：基于视频内容，分析其在更广阔背景下的意义，或提供补充性的背景知识。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{section2}
- **氛围洞察**：分析弹幕的情绪曲线，识别观众在哪一时刻反响最热烈。
- **高频词云**：提取真实的重复关键词汇，并解读背后的观众心理。
- **互动槽点**：捕捉视频中的"梗"、争议点或共鸣点。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{section3}
- **评论画像**：分析高赞评论的构成，观众是在补充干货、表达感谢还是进行理性讨论？
- **精选解读**：深入分析提供的精彩评论，提取其中最有价值的观点或纠错信息。
- **后续优化建议**：基于目前的观众反馈，为UP主提供具体可执行的改进方案或新选题灵感。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**输出格式**：
- {output_md}
- 保持专业、客观的语气。
- 如果信息不足以支撑某个子标题，请删除该标题。"""


def get_summary_prompt(video_info: Dict, content: str) -> str:
    """
    获取视频总结提示词

    Args:
        video_info: 视频信息字典
        content: 视频内容

    Returns:
        总结提示词
    """
    return f"""请为以下B站视频生成详细的总结报告：

【视频信息】
标题：{video_info.get('title', '未知')}
作者：{video_info.get('author', '未知')}
简介：{video_info.get('desc', '无')}

【视频内容】
{content[:Config.MAX_SUBTITLE_LENGTH]}

请提供以下内容：
1. **内容概述**（3-5句话概括视频主要内容）
2. **详细总结**（按逻辑结构详细总结视频内容，分段呈现）
3. **关键要点**（列出5-10个核心知识点）
4. **适用人群**（说明这个视频适合什么人观看）
5. **学习建议**（给出具体的学习建议）

请用清晰的Markdown格式输出，使用标题、列表等格式化元素。"""


def get_mindmap_prompt(video_info: Dict, content: str, summary: Optional[str] = None) -> str:
    """
    获取思维导图提示词

    Args:
        video_info: 视频信息字典
        content: 视频内容
        summary: 已有总结（可选）

    Returns:
        思维导图提示词
    """
    base_content = f"""请为以下视频内容生成思维导图（使用Markdown格式）：

【视频标题】
{video_info.get('title', '未知')}

【视频内容】
{content[:Config.MAX_SUBTITLE_LENGTH]}
"""

    if summary:
        base_content += f"\n【已有总结】\n{summary}\n"

    base_content += """
请用Markdown格式的层级列表生成思维导图，结构清晰，层次分明。

格式示例：
# 视频标题
## 第一部分：核心概念
- 要点1
  - 子要点1.1
  - 子要点1.2
- 要点2
## 第二部分：具体内容
- 要点3
  - 子要点3.1

请确保：
1. 最多4层层级
2. 每个节点简洁明了
3. 逻辑结构清晰
4. 涵盖主要内容"""

    return base_content


def get_chat_qa_system_prompt(video_info: Dict, context: str) -> str:
    """
    获取视频问答系统提示词

    Args:
        video_info: 视频信息字典
        context: 视频分析结果上下文

    Returns:
        问答系统提示词
    """
    return f"""你是一个基于B站视频分析结果的问答助手。

【核心指令】
1. **绝对忠于上下文**：你的知识库仅限于下方提供的【视频分析报告】。
2. **严禁编造**：如果报告中没有提到用户提问的细节（如具体的数字、人名、画面细节等），你**必须**回答"根据当前的分析报告，我没有找到相关信息"，严禁基于常识或猜测进行回答。
3. **不确定性处理**：如果信息模糊，请如实描述报告中的模糊之处，不要将其确认为事实。

【视频基本信息】
标题: {video_info.get('title', '未知')}
UP主: {video_info.get('author', '未知')}

【视频分析报告】
{context}
"""


def get_article_analysis_prompt(article_info: Dict, content: str) -> str:
    """
    获取专栏文章分析提示词

    Args:
        article_info: 文章信息字典
        content: 文章内容

    Returns:
        文章分析提示词
    """
    return f"""你是一位专业的深度报道评论员。请为以下B站专栏文章生成一份详尽的分析报告。

【文章信息】
标题：{article_info.get('title', '未知')}
作者：{article_info.get('author', '未知')}

【文章完整内容】
{content[:Config.MAX_SUBTITLE_LENGTH]}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
请严格按照以下结构提供分析报告：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📋 文章深度解析
- **核心论点**：用一句话概括文章想要表达的最核心观点。
- **内容精要**：系统性地总结文章的分点论述，逻辑清晰，内容充实。
- **深度点评**：分析文章的写作风格、专业深度以及对行业/读者的启发意义。

## 💡 知识图谱
- 提取并解释文章中提到的专业术语或背景知识。

## 🚀 阅读建议
- 适合哪类人群深度阅读？
- 相关的延伸阅读方向。
"""


def get_user_portrait_prompt(user_info: Dict, videos_text: str) -> str:
    """
    获取UP主画像生成提示词

    Args:
        user_info: 用户信息字典
        videos_text: 视频列表文本

    Returns:
        UP主画像提示词
    """
    return f"""你是一位资深的自媒体行业分析师。请根据以下UP主的公开信息和近期作品数据，生成一份**深度、专业且具有洞察力**的UP主画像报告。

【UP主基础信息】
- 昵称：{user_info.get('name')}
- 签名：{user_info.get('sign')}
- 等级：L{user_info.get('level')}
- 认证信息：{user_info.get('official') or '普通用户'}

【近期作品数据（采样）】
{videos_text}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
请按以下结构输出深度分析（使用 Markdown 格式，多用 Emoji）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### 🎭 创作者标签
- 用 3-5 个关键词精准定义该 UP 主（如：硬核技术流、极简主义者、高产赛母猪等）。

### 📈 内容风格与调性
- 分析其视频的标题风格、选题偏好及内容深度。
- 观察其作品的生命力（从播放量与选题的关联度分析）。

### 💎 核心价值主张
- 该 UP 主为粉丝提供了什么独特价值？（是知识获取、情绪价值还是审美共鸣？）

### 🚀 发展潜力评估
- 基于近期作品的表现，分析其内容的垂直度及未来增长空间。

### 💡 合作/关注建议
- 给想关注该 UP 主或与其合作的品牌方提供一条诚恳的建议。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
请保持专业、客观且富有文学色彩的笔触，字数在 300-500 字左右。"""
